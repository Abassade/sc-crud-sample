<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/sc-socket.html">

<dom-module id="sc-model">
  <template>
    <sc-socket socket="{{socket}}"></sc-socket>
  </template>

  <script>
    Polymer({
      is: 'sc-model',
      
      properties: {
        modelType: {
          type: String,
          value: 'field'
        },
        resourceType: {
          type: String,
          observer: 'loadValue'
        },
        resourceId: {
          type: Number,
          observer: 'loadValue'
        },
        resourceField: {
          type: String,
          observer: 'loadValue'
        },
        resourceValue: {
          type: Object,
          notify: true
        },
        resourcePage: {
          type: Number,
          value: 0,
          observer: 'loadValue'
        },
        socket: {
          type: Object
        },
        channel: {
          type: Object
        }
      },
      
      attached: function () {
        this.loadValue();
      },
      
      loadValue: function () {
        var self = this;
        
        if (this.socket) {
          this.cleanupChannel();
          
          var query = {
            type: this.resourceType,
            id: this.resourceId,
            field: this.resourceField
          };
          
          var sourcePath = '';
          if (this.modelType == 'collection') {
            sourcePath += this.resourcePage + ':';
            query.page = this.resourcePage;
          }
          
          if (this.resourceField) {
            sourcePath += this.resourceType + '/' + this.resourceId + '/' + this.resourceField;
          } else if (this.resourceId) {
            sourcePath += this.resourceType + '/' + this.resourceId;
          } else {
            sourcePath += this.resourceType;
          }
          
          // Get the initial value for the model
          var loadData = function () {
            self.socket.emit('get', query, function (err, data) {
              if (err) {
                // TODO: Handle error
              } else {
                self.resourceValue = data;
              }
            });
          };
          
          // This is to account for socket reconnects - After recovering from a lost connection,
          // we will re-fetch the whole value to make sure that we haven't missed any updates made to it
          this.socket.on('connect', function (status) {
            loadData();
          });
          
          if (this.socket.state == 'open') {
            loadData();
          }
          
          // Subscribe to further changes while this model is active
          this.channel = this.socket.subscribe(sourcePath);
          this.watcher = function (packet) {
            self.resourceValue = packet.value;
          };
          
          // Consume the realtime channel data as it arrives
          this.channel.watch(this.watcher);
        }
      },
      
      cleanupChannel: function () {
        if (this.channel) {
          this.channel.unwatch(this.watcher);
          if (!this.channel.watchers().length) {
            this.channel.unsubscribe();
          }
        }
      },
      
      detached: function () {
        this.cleanupChannel();
      },
      
      save: function (newValue, callback) {
        this.resourceValue = newValue;
      
        var query = {
          type: this.resourceType,
          id: this.resourceId,
          field: this.resourceField,
          value: newValue
        };
        // Update the model on the server
        this.socket.emit('set', query, callback);
      },
      
      // Only relevant for array/list models
      add: function (callback) {
        var query = {
          type: this.resourceType,
          id: this.resourceId,
          field: this.resourceField
        };
        // Add new entry to model on the server
        this.socket.emit('add', query, callback);
      }
    });
  </script>
</dom-module>